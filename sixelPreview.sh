#!/bin/bash

usage() {
    echo "Useag: sixelPreviewer.sh [OPTIONS] WATCH_FILE_EXT"
    echo
    echo "Options:"
    echo "  -h, --help : print help."
    echo "  -w : fit width mode."
    echo
    exit 1
}

# オプション抽出
for OPT in "$@"
do
    case "$OPT" in
        '-h'|'--help' )
            usage
            exit 1
            ;;
        '-w' )
            fit_width_mode_param="-w"
            shift 1
            ;;
        *)
            param+=( "$1" )
            shift 1
            ;;
    esac
done

# オプション以外の抽出
ext=${param[0]}
run_tty=`tty`

# 第一引数で指定された拡張子の画像ファイルを監視し、
# 変更があれば画像表示コマンドを実行する設定ファイルを作成。
GOEMON_FILE=" # Generated by sixelPreview.sh
tasks:
- match: '*.${ext}'
  commands:
      - printImg.sh ${fit_width_mode_param} \${GOEMON_TARGET_FILE} ${run_tty}
"

# goemon 設定ファイル作成
cat <<< "${GOEMON_FILE}" > ./goemon.yml

# goemon 起動
goemon -- 2> /dev/null &

# preview 用 bash の起動
PS1="" /bin/bash --norc

# goemon 停止
killall goemon

# goemon 設定ファイル削除
rm goemon.yml
